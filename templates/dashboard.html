{% raw %}
{% extends 'layout.html' %}

{% block title %}Dashboard - {{ config.nome or 'Cliente' }}{% endblock %}

{% block content %}
<div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Configuração</h5>
                    <p>Status: <span class="badge bg-{{ 'success' if config_completa else 'warning' }}">
                        {{ 'Completa' if config_completa else 'Pendente' }}
                    </span></p>
                    <p class="card-text"><strong>Cliente ID:</strong> <code>{{ cliente_id }}</code></p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Próxima Execução</h5>
                    <p class="card-text">O robô verifica os feeds a cada 15 minutos (configurado no Render).</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4>Feeds Configurados</h4>
                </div>
                <div class="card-body">
                    {% if feeds %}
                        {% for feed in feeds %}
                            <div class="mb-3 p-2 border rounded">
                                <h5>{{ feed.nome }}</h5>
                                <p class="text-muted small" style="word-break: break-all;"><strong>URL:</strong> {{ feed.url }}</p>
                                <p><strong>Tipo:</strong> {{ feed.tipo | upper }} | <strong>Categoria:</strong> {{ feed.categoria or 'Geral' }}</p>
                                <button class="btn btn-sm btn-danger" onclick="removerFeed({{ feed.id }})">
                                    <i class="bi bi-trash"></i> Remover
                                </button>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>Nenhum feed configurado ainda.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4>Adicionar Novo Feed</h4>
                </div>
                <div class="card-body">
                    <form id="feedForm">
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome do Feed</label>
                            <input type="text" class="form-control" id="nome" name="nome" required placeholder="Ex: Notícias Urgentes">
                        </div>
                        <div class="mb-3">
                            <label for="url" class="form-label">URL do Feed</o-label>
                            <input type="url" class="form-control" id="url" name="url" required placeholder="https://.../rss ou /feed.json">
                        </div>
                        <div class="mb-3">
                            <label for="tipo" class="form-label">Tipo</label>
                            <select class="form-select" id="tipo" name="tipo" required>
                                <option value="rss">RSS</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="categoria" class="form-label">Categoria (Opcional)</label>
                            <input type="text" class="form-control" id="categoria" name="categoria" placeholder="Ex: Urgente">
                        </div>
                        <button type="submit" class="btn btn-primary">Adicionar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('feedForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        try {
            const response = await fetch('/adicionar-feed', {
                method: 'POST',
                body: formData // Enviar como multipart/form-data é OK
            });
            
            const result = await response.json();
            
            if (result.sucesso) {
                alert(result.mensagem);
                location.reload(); // Recarrega a página para mostrar o novo feed
            } else {
                alert('Erro ao adicionar feed: ' + result.erro);
            }
        } catch (error) {
            console.error('Fetch error:', error);
            alert('Erro de conexão. Verifique o console para mais detalhes.');
        }
    });
    
    async function removerFeed(feedId) {
        if (confirm('Tem certeza que deseja remover este feed?')) {
            try {
                // CORREÇÃO: Usando o método POST
                const response = await fetch(`/remover-feed/${feedId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.sucesso) {
                    alert(result.mensagem);
                    location.reload(); // Recarrega a página para atualizar a lista
                } else {
                    alert('Erro ao remover feed: ' + result.erro);
                }
            } catch (error) {
                console.error('Fetch error:', error);
                alert('Erro de conexão. Tente novamente.');
            }
        }
    }
</script>
{% endblock %}
{% endraw %}
